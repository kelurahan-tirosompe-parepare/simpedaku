<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SIMPEDAKU</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
  </head>
  <body>
<!-- Modal -->
<div class="modal" id="modalLoading" tabindex="-1" aria-labelledby="modalLoadingLabel" aria-hidden="true">
  <div class="modal-dialog h-100">
      <div class="modal-content bg-transparent border-0 h-100">
         <div class="row align-items-center h-100">
            <div class="col">
              <div class="d-flex justify-content-center">
                  <div class="spinner-border text-light" role="status">
                      <span class="visually-hidden">Loading...</span>
                  </div>
              </div>
            </div>
          </div>
      </div>
   </div>
</div>

    
    <div class="container">
      <div style="height:100px" class="border-bottom mb-5">
        <h1>{{dataUser.nama}}</h1>
      </div>
      <!--      SURAT KETERANGAN-->
      <!--     <h3>SURAT KETERANGAN</h3> -->
      <div class="btn-group">
        <div class="dropdown">
          <button
            class="btn btn-secondary dropdown-toggle"
            type="button"
            data-bs-toggle="dropdown"
            aria-expanded="false"
          >
            -- Pilih --
          </button>
          <ul class="dropdown-menu" id="suket">
            {{#each dataList}}
              <li><a
                  class="dropdown-item"
                  id="dropdown-{{@key}}"
                  href="#dropdown-{{@key}}"
                  aria-controls="dropdown-{{@key}}"
                >{{@key}}</a></li>
            {{/each}}
          </ul>
        </div>
      </div>

      <!--  form -->
      <div class="my-3 p-3 border">
        <h3 id="namaForm" class="mb-3"></h3>
        <form id="kirim" enctype="multipart/form-data">
          <div id="isiForm" class="border p-3 mb-3">

          </div>
          <div class="text-end">
            <button type="submit" class="btn btn-primary disabled">Kirim</button>
          </div>
        </form>
        <p id="status">
          
        </p>
      </div>
    </div>
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
    <script>
      // let submitMati = $('button[type="submit"]').hasClass('disabled')
      // if(!submitMati){
      //   $('button[type="submit"]').addClass('disabled')
      // }
      
      const modalLoading = new bootstrap.Modal('#modalLoading')
      
      const templateForm = (isi) => { 
        return `<div class="mb-3"> <label
      for="form${isi}" class="form-label">${isi}</label> 
      <input name="${isi}" class="form-control" id="form${isi}" type="file" accept="image/*"
      capture="user" /> </div>` };
      
      const dropdownItems = document.querySelectorAll(".dropdown-item"); 
      const listForm = JSON.parse('{{{dataForm}}}');

      
                                  
      dropdownItems.forEach((item) => {
      item.addEventListener("click",function(event) {
          event.preventDefault();
          
          if($('input')){
            $('button[type="submit"]').removeClass('disabled')
          }
        
          $(namaForm).html($(item).html());
            $(isiForm).html("");
            const itemId = (item.getAttribute("id")).slice(9, item.getAttribute("id").length);
            const formArr = listForm[itemId];
        
            formArr.forEach((item, index) => {
                $(isiForm).prepend(templateForm(item)) }) 
            }) 
      }); 
      

        $(kirim).on("submit", async function(ev){ 
            ev.preventDefault()
          
              var kosong = false
              $('input').each(function(){
                  if(!this.value){
                      kosong = true
                      return false
                  }
              })
          
          if(kosong){
            alert('Lengkapi berkas!')
            return false
          }
          
          var formData = new FormData(ev.target);
        
              formData.append("nik", "{{dataUser.nik}}")
              formData.append("password", "{{dataUser.password}}") 
              formData.append("rw", {{dataUser.rw}})

          if (formData) {
            $('button[type="submit"]').removeClass('disabled')
            const fileList = Object.fromEntries(formData.entries());
            // console.log(fileList)
            
            for (const value of formData.values()) {
              console.log(value);
            }
            
            $.ajax({
              type: "POST",
              url: "/kirimfile",
              data: formData,
              processData: false,
              contentType: false,
              beforeSend: function(){
                modalLoading.show()
              }})
              .done(function(response) {
                  // Tindakan setelah pengunggahan berhasil, misalnya menampilkan pesan sukses
                  $('input').val('')
                  alert(`Gambar berhasil diunggah: ${response.pesanServer}`);
                })
              .fail(function( err ) {
                // Tindakan jika terjadi kesalahan
                alert(JSON.stringfy(err));
              })
              .always(function(){
                modalLoading.hide()
              })
          } else {
            $('#status').text('Pilih gambar terlebih dahulu.');
          }
      })
      
      
    </script>
  </body>
</html>